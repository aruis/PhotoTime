# PhotoTime 音频 v1 实现草案与风险清单

## 目标与边界
- 目标：在不引入复杂音频编辑能力的前提下，完成单轨音频的导入、预览试听、导出混流闭环。
- 范围内：
  - 单轨音频文件导入（选择/拖拽）
  - 时间轴感知（音轨可视化 + 循环开关）
  - 预览阶段可听（基于当前时间点试听）
  - 导出阶段混流（可选循环至视频结束）
  - 异常可恢复（用户可理解提示 + 不崩溃）
- 范围外（后置）：
  - 多轨、裁剪、淡入淡出、包络线、节拍对齐
  - 音频效果器链与高级母带处理

## 当前实现概览
- 配置层：
  - `RenderEditorConfig` 已承载 `audioEnabled/audioFilePath/audioVolume/audioLoopEnabled`。
- UI 层：
  - 音频设置区支持选择/清除/拖拽导入、音量、循环开关。
  - 视频预览区显示音轨分段与循环状态，支持试听/暂停/停止。
- 渲染层：
  - 导出先产出视频，再执行音频混流，避免受限目录临时文件权限问题。
  - 支持不循环与循环两种拼接策略，日志输出包含 `loop=on/off`。
- 错误恢复：
  - 音频校验失败可在 UI 直接反馈并阻断非法导出请求。
  - 导出失败卡片保留重试与日志定位入口。

## 流程草案（用户视角）
1. 开启“启用背景音频”。
2. 通过“选择音频”或拖拽导入单条音频。
3. 在视频预览中查看音轨覆盖区间，按需切换“自动循环至视频结束”。
4. 拖动时间轴到目标时间点，点击“试听当前时间点”确认听感。
5. 导出 MP4，成功信息包含“音频已附加单轨背景音频”。

## 技术草案（实现视角）
- 导入与校验：
  - 入口统一收敛到 `applyAudioTrack`，避免选择与拖拽路径分叉。
  - 校验使用 `AudioTrackValidation.validate(url:)`，失败即就地提示。
- 预览试听：
  - 使用 `AVAudioPlayer` 做轻量本地试听，能力限定为播放/暂停/停止/定位。
  - 时间轴变更时同步 `currentTime`，循环开关映射 `numberOfLoops`。
- 导出混流：
  - 继续沿用 `AudioMuxer`，以最终输出路径写入，避免目录权限问题。
  - 当 `loopEnabled=false`：音频按原长截断到视频长度。
  - 当 `loopEnabled=true`：按音频时长重复铺满视频时长。

## 风险清单与缓解策略
1. 权限与路径风险（导出目录不可写或中间文件替换失败）
- 现状：已通过“先临时导出视频、后直接写最终混流文件”规避高风险路径操作。
- 策略：继续避免在用户选定目录创建/替换额外临时文件。

2. 编码兼容风险（部分音频格式可识别但不可稳定解码）
- 现状：已有基础校验与错误提示。
- 策略：失败时保留原始错误并给出可执行动作（更换文件/重试/查看日志）。

3. 试听与导出行为不一致风险（用户误判）
- 现状：试听支持从当前时间点播放，导出支持循环开关。
- 策略：在 UI 明示“预览仅基础试听，不含复杂编辑”；继续保持循环开关与导出一致。

4. 长音频/短音频与视频时长不匹配风险
- 现状：非循环截断、循环铺满已实现并有回归测试。
- 策略：保留时间轴可视化，帮助用户在导出前感知覆盖范围。

5. 并发状态风险（导出中、切页、配置变更时播放器状态错乱）
- 现状：已在切换预览模式/页面消失时停播。
- 策略：保持 `isAudioPreviewPlaying` 单一真值源，所有入口调用统一停播逻辑。

## 验收与回归建议
- 功能验收：
  - 单轨选择与拖拽均可导入；
  - 预览可听，时间轴定位有效；
  - 导出后有音频，循环开关行为正确；
  - 非法音频不崩溃，提示可理解。
- 回归重点（非 UI）：
  - `RenderEngineSmokeTests` 音频 4 条用例；
  - `ExportViewModelPreflightFlowTests` 音频导入与试听失败场景用例。

## 下一阶段建议（不属于 v1）
1. 增加导出前“音频时长与覆盖策略”摘要提示（提升可预期性）。
2. 增加“音频淡入/淡出”最小开关（仍保持单轨）。
3. 评估是否引入 `AVAudioEngine` 作为 v2 能力基础（仅当确有复杂编辑需求）。
