# PhotoTime Release Checklist

适用范围：发布前分支（`main`）准备阶段。  
目标：在发版前收口权限、磁盘、兼容性、失败恢复链路的关键风险。

## 1. 自动化门禁（必须通过）

执行：

```bash
./scripts/release-gate.sh
```

通过标准：

- `MACOSX_DEPLOYMENT_TARGET` 与基线一致（14.6）。
- CI 工作流仍包含三类质量门：`Non-UI Tests`、`Audio Regression`、`UI Smoke`。
- CI 使用 `setup-xcode` 且 `xcode-version: latest-stable`。
- 本地质量门 `./scripts/test-ci-gate.sh` 全绿。

## 2. 手工检查（发布责任人确认）

1. 权限链路
- 首次导入素材时可正常选择并读取文件。
- 导出到用户目录（如“影片”）可成功写入。
- 权限拒绝场景出现友好提示，且可引导用户恢复（重试/重新选择素材）。

2. 磁盘与路径链路
- 在可写目录导出成功，输出文件与日志文件均可定位。
- 不可写/空间不足场景下，失败信息包含明确建议动作。

3. 兼容性链路
- 在目标最低系统版本（macOS 14.6）验证主路径：导入 -> 预览 -> 导出。
- 导入模板（旧版本模板）与导出模板回环行为正常。

4. 失败恢复链路
- 导出失败后能看到：错误头、建议动作、日志路径、问题素材定位信息。
- “重试上次导出”与“重新选择素材”动作符合预期。

## 3. 发布留档（建议）

- 保留一份最新 `CI` 通过链接。
- 若发布前出现失败，执行：

```bash
./scripts/collect-diagnostics.sh
```

将打包结果（`.tar.gz`）附到排障记录中。

## 4. 回滚预案（必须预先确认）

### 4.1 触发条件（任一满足即回滚）

- 发布后出现 `P0` 故障：应用无法启动、主路径（导入 -> 预览 -> 导出）不可用。
- 发布后出现 `P1` 且 30 分钟内无法给出可验证修复：导出高频失败、数据/文件损坏风险、无法恢复的权限链路问题。
- 质量门在发布后复跑出现系统性失败，且影响可交付判定（非单点 flaky）。

### 4.2 回滚步骤

1. 发布责任人确认触发条件并在发布记录中标记 `rollback-start` 时间。
2. 停止继续扩散当前版本（暂停后续发布动作与外部分发）。
3. 切回上一个已验证 tag/commit，重新构建发布包。
4. 对回滚版本执行最小验证：
   - `./scripts/release-gate.sh`
   - 手工走通一次主路径（导入 -> 预览 -> 导出）
5. 用回滚包替换当前分发版本，并记录 `rollback-complete` 时间。
6. 执行 `./scripts/collect-diagnostics.sh`，将诊断包附到事故记录，进入后续复盘。

### 4.3 回滚完成验证

- 回滚版本可正常启动，且主路径可达成。
- 失败恢复链路可用（失败卡片动作与日志打开正常）。
- 发布记录包含：触发条件、责任人、开始/完成时间、回滚目标版本、验证结果。

### 4.4 角色与时限

- 触发与决策责任人：当班发布责任人（Release Owner）。
- 执行时限：触发后 15 分钟内完成“是否回滚”决策，60 分钟内完成回滚并验证。

## 5. 发布演练记录

- 每次演练结果写入 `Docs/Release-Rehearsal-Log.md`，至少记录：
  - 演练时间与分支/commit
  - 各门禁耗时与通过情况
  - 发布包产物路径与校验信息
  - 阻塞项与下一步动作
