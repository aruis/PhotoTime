# Engineering Guardrails

目标：确保迭代过程中优先维护长期可维护性，不以短期交付速度交换隐性技术债。

## 1. 设计与分层约束

1. `ContentView` 只负责 UI 组装与交互绑定，不承载导出/渲染业务编排。
2. 导出、音频、素材、诊断等能力必须落在独立模块/扩展，避免单文件膨胀。
3. 错误处理优先结构化（错误码、阶段、建议动作），禁止新增字符串关键词硬编码分支。

## 2. 变更准入标准（DoD）

每个 PR 至少满足：

1. 行为可验证：新增或修改路径必须有自动化测试覆盖（单测或 UI smoke）。
2. 失败可定位：失败信息需能定位到阶段和下一步动作。
3. 文档同步：影响交付流程/运行方式的改动必须更新 `README` 或 `Docs`。
4. 无新增隐性债务：不得引入无跟踪的 `TODO/FIXME/HACK` 标记。

## 2.1 任务准入与止损（新增）

1. 每项任务进入迭代前必须声明“直接改善指标”：
   - 主路径成功率
   - 失败定位速度
   - 首次导出可达成率
2. 若任务无法直接改善上述任一指标，默认降级到 backlog，不占用当期主线资源。
3. 边缘项采用半天限时盒：连续投入超过半天仍未形成可验证收益，立即暂停并复盘。

## 3. 技术债管理策略

1. 原则上不接受“先堆后还”式提交。
2. 必须引入债务时，需绑定可追踪任务并在同迭代清偿。
3. 对大改动采取“渐进重构 + 护栏测试”策略，禁止一次性重写核心链路。

## 3.1 CI 投入边界（新增）

1. CI 目标是“阻断高风险回归”，不是“覆盖一切可能”。
2. 仅维持核心门禁：维护性检查 + non-ui + 音频回归 + UI smoke。
3. 新增 CI 作业需满足：
   - 能拦截真实高频问题，且
   - 单次新增耗时可控（默认不超过 5 分钟），否则需替代或合并现有作业。

## 4. 自动化护栏

1. `./scripts/check-maintainability.sh`
   - 拦截新增债务标记（`TODO/FIXME/HACK/XXX`）。
   - 限制核心文件行数上限，避免再次回到巨石文件。
2. `./scripts/test-ci-gate.sh`
   - 在测试门禁前先运行维护性检查。
3. CI 必须执行维护性检查 + 非 UI + 音频回归 + UI smoke。
