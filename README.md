# PhotoTime

PhotoTime 是一个面向摄影爱好者的 macOS 幻灯片导出工具。

## 远期目标（可迭代）
以下目标作为当前版本的长期方向，后续可根据实际进展持续微调。

1. 对标 Lightroom 的幻灯片导出能力（聚焦核心场景，不追求全产品覆盖）。
2. 极致易用、容易上手：支持拖拽导入，参数清晰，预览即所得（WYSIWYG）。
3. 导出体验稳定可预期：核心流程清晰，用户能在少步骤内完成导出。
4. 提供高价值可定制性：
   - 相框风格（相框颜色、背景颜色，含预置 + 自定义）
   - 相框边距
   - 横竖图策略（优先读取素材默认方向）
   - 展示时长、过渡时长、是否淡入淡出
   - 单轨音频导入与预览（复杂音频编辑能力后置讨论）
5. 出错不崩溃，反馈友好：即使失败也应给出可理解原因与可执行下一步。

## 目标对齐与投入边界（新增）
为了保证“面向生产交付”而不是“局部打磨”，后续迭代统一按以下边界执行：

1. 只优先投入主路径：`导入 -> 预检 -> 预览 -> 导出 -> 失败恢复`。
2. 任何任务若不能直接提升以下至少一项，则默认不进当前迭代：
   - 主路径成功率
   - 失败定位速度
   - 新用户首次可达成率
3. 边缘路线（视觉细枝末节、低频配置、过度工程化脚本）采用“限时盒”：
   - 单项投入超过半天仍无明确产出，立即降级或暂停。
4. CI 维持“够用即可”：
   - 仅保留会阻断交付质量的门禁（maintainability + non-ui + audio + ui smoke）。
   - 暂不扩展长尾矩阵（多版本/多环境大规模并发）直到主路径指标稳定。

## 设计哲学（优先级参考）
- 80% 功能完备度
- 99% 易用度
- 90% 美观度与设计感
- 80% 成功率（阶段参考值）

> 注：以上比例用于优先级取舍，不作为严格数学指标。

## 阶段基线（v2 已完成）
对齐依据：`Docs/UI-Information-Architecture-v1.md`（流程与信息架构基线）。

1. 导出前风险甄别闭环（Preflight）
- [x] 导出前自动扫描所有素材（可读性、损坏、权限、尺寸/方向异常）。
- [x] 风险按级别展示：`可继续` / `建议处理` / `必须修复`。
- [x] 能定位到具体问题图片（至少文件名级别）。
- [x] 用户可一键选择“跳过问题素材并继续导出”。
- [x] Preflight 结果在导出界面可见，不依赖日志。

2. 预览即所得闭环（WYSIWYG）
- [x] 预览与导出使用同一套关键参数（时长、转场、Ken Burns、边距、风格）。
- [x] 时间轴拖动时有明确状态反馈（生成中/失败/成功）。
- [x] 关键时刻帧一致性测试稳定通过（默认风格 + 主要变体）。
- [x] 预览失败不影响后续继续操作（不崩溃、可恢复）。

3. 核心可定制性闭环
- [x] 相框与背景支持“预置风格 + 自定义颜色”。
- [x] 相框边距可视化可调。
- [x] 横竖图策略可配置（默认读取素材方向，并支持覆盖）。
- [x] 展示时长、过渡时长、淡入淡出开关在 UI 可直接调整。
- [x] 模板导入/导出可覆盖以上配置且向后兼容。

4. 音频 v1 闭环（单轨）
- [x] 支持拖拽或选择单条音频。
- [x] 可在预览中听到音频（基础预览即可）。
- [x] 导出视频含音频并与时间轴同步。
- [x] 音频异常（不可读/不支持）有友好提示且不崩溃。

5. 最小可用流程与 UI 完成度
- [x] 用户可在一个主界面完成“导入-预览-导出-恢复”。
- [x] 主操作/辅助操作分区清晰，按钮状态与状态机一致。
- [x] 失败卡片提供明确“下一步动作”，成功卡片提供“继续动作”。
- [x] 参数校验信息就地显示（inline），无需猜测错误原因。
- [x] 新用户在无文档条件下可完成首次导出。

## 中期目标（未来 4-8 周）
以“可稳定发布 v3”为目标，范围只覆盖主路径高收益项。

1. 主路径可观测性闭环
- [ ] 在应用内增加“最近一次失败摘要”入口（阶段 + 建议动作 + 诊断包位置）。
- [ ] 将高频失败类型映射为固定修复建议模板，减少同类问题重复排查。

2. 关键路径回归效率
- [ ] 收口 UI smoke 到 3-5 条高价值场景，确保 15 分钟内完成主门禁。
- [ ] 为导出参数组合补最小覆盖矩阵（方向策略 x 转场开关 x 音频有/无）。

3. 交付可预测性
- [ ] 完成一次“从主干到可发布包”的全链路演练并沉淀耗时基线。
- [ ] 将发布清单中可自动化项脚本化，减少人工漏检。

## 短期目标（当前两周）
### 第 1 周：主路径收敛（快速见效）
1. `ContentView` 继续减负
- [x] 将剩余设置/预览相关大块 UI 继续拆到独立组件，`ContentView.swift` 控制在 700 行以内。
- [ ] 保持行为等价，避免视觉与交互回退。

2. 失败恢复体验收口
- [x] 统一失败卡片文案来源，确保“问题是什么/下一步做什么”两段信息稳定输出。
- [x] 补一组 UI smoke：覆盖“导出失败 -> 查看建议 -> 修正后重试成功”。

3. 低收益事项止损
- [ ] 暂停非主路径重构（复杂主题系统、低频参数细粒度优化）。
- [ ] 新增任务在进入开发前必须标注“对应提升指标”。

### 第 2 周：发布准备（不扩边界）
1. 质量门提效
- [ ] 精简重复测试，保证本地 `./scripts/test-ci-gate.sh` 30 分钟内可完成。
- [ ] 对不稳定用例做隔离或修复，避免门禁噪声。

2. 发布演练与回滚预案
- [ ] 完成一次完整发布演练（含失败恢复与诊断包导出）。
- [ ] 明确回滚步骤与触发条件，并写入 `Docs/Release-Checklist.md`。

3. 验收出口（两周末）
- [ ] 主路径无 P0/P1 已知缺陷。
- [ ] 新用户可在无文档条件下完成首次导出（回归脚本可复现）。
- [ ] 核心失败场景能在 10 分钟内定位阶段并给出下一步动作。

## 近期已完成（2026-02）
1. 完成“横竖图策略可配置”
- [x] 增加 `按素材方向 / 强制横图 / 强制竖图` 三档。
- [x] 预览与导出行为一致，并补对应测试。

2. 完成模板兼容性收口
- [x] 为新加入字段补模板兼容测试（老模板导入默认值）。
- [x] 为“风格/布局/铭牌/转场开关”补导出-导入回环验证。

3. 完成首用可达成度验证
- [x] 新用户脚本化走通“导入-预览-导出”并记录阻塞点。
- [x] 根据阻塞点微调文案与默认值（不做视觉重构）。
  - 已调整：默认导出路径自动落在“影片/PhotoTime-Output.mp4”，并补充首屏引导文案。

4. 音频 v1 设计与技术预研
- [x] 确认最小方案：单轨导入、预览可听、导出混流。
- [x] 形成实现草案与风险清单（暂不进入复杂编辑）。
  - 详见：`Docs/Audio-v1-Implementation-Plan.md`

5. 当前迭代对齐项
- [x] 导出状态文案统一构建，降低文案散落与后续修改成本。
- [x] 新增本地回归脚本：`./scripts/test-non-ui.sh`、`./scripts/test-audio-regression.sh`。
- [x] 新增关键 UI smoke 脚本：`./scripts/test-ui-smoke.sh`，并提供总门禁脚本 `./scripts/test-ci-gate.sh`。
- [x] 修复音频时长读取过时 API（`AVURLAsset.duration`）并清理缩略图 actor 警告。
- [x] 补齐异步音频时长刷新回归测试（导入后可读、移除后清空）。
- [x] 增加导出失败类型本地聚合统计（`~/Library/Application Support/PhotoTime/Diagnostics/export-failure-stats.json`）。
- [x] 在应用“更多”菜单增加“导出排障包”入口（生成并打开诊断包目录）。
- [x] 导出前增加输出路径规范与可写性校验（`.mp4` 扩展名、目录路径、写权限），异常时即时提示并阻断导出。

## 已确认产品取舍（当前版本）
- 兼容性：最低兼容版本统一为 `macOS 14.6`。
- 优先级：按“短期两周计划 -> 中期 v3 目标”顺序推进，优先保证稳定性与可交付性。
- 暂不做：项目保存/复用（前提是稳定性已足够）。
- 暂不做：面向用户的稳定性指标看板与长期跟踪（前提是导出前风险甄别充分）。
- 错误处理：重点是“不崩溃 + 友好提示 + 尽可能定位到问题图片”。
- 日志定位：日志保留给开发排查使用，但不作为用户主路径能力。

## 本地测试（当前策略）
- 默认先跑非 UI 测试，再按需补关键 UI smoke。
- 一键命令：
  - `./scripts/test-non-ui.sh`
- 音频导出关键回归（单轨附加 + 非循环 + 循环）：
  - `./scripts/test-audio-regression.sh`
- 关键 UI smoke（首用状态 + 成功/失败/校验场景）：
  - `./scripts/test-ui-smoke.sh`
- 本地 CI 门禁串联（non-ui + audio + ui smoke）：
  - `./scripts/test-ci-gate.sh`
- 可维护性护栏检查（技术债标记 + 核心文件体量预算）：
  - `./scripts/check-maintainability.sh`
- 发布前门禁（含兼容性/CI配置检查 + 本地质量门）：
  - `./scripts/release-gate.sh`
- 一键采集最小排障包（环境信息 + 导出失败聚合 + 最近 render 日志 + 配置快照）：
  - `./scripts/collect-diagnostics.sh`
- 发布清单文档：
  - `Docs/Release-Checklist.md`
- 工程可维护性守则：
  - `Docs/Engineering-Guardrails.md`
- GitHub Actions CI：
  - `.github/workflows/ci.yml` 在 `push/pull_request` 上并行执行：
    - Non-UI Tests
    - Audio Regression
    - UI Smoke
  - 失败时自动上传 `xcresult` 产物，便于定位问题。
- 等价 `xcodebuild` 命令（带 ad-hoc 签名，避免本机调试库签名导致的测试启动失败）：
  - `xcodebuild test -project PhotoTime.xcodeproj -scheme PhotoTime -destination 'platform=macOS' -derivedDataPath .derivedData CODE_SIGNING_ALLOWED=YES CODE_SIGNING_REQUIRED=NO CODE_SIGN_IDENTITY='-' -only-testing:PhotoTimeTests`
