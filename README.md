# PhotoTime

PhotoTime 是一个面向摄影爱好者的 macOS 幻灯片导出工具。

## 远期目标（可迭代）
以下目标作为当前版本的长期方向，后续可根据实际进展持续微调。

1. 对标 Lightroom 的幻灯片导出能力（聚焦核心场景，不追求全产品覆盖）。
2. 极致易用、容易上手：支持拖拽导入，参数清晰，预览即所得（WYSIWYG）。
3. 导出体验稳定可预期：核心流程清晰，用户能在少步骤内完成导出。
4. 提供高价值可定制性：
   - 相框风格（相框颜色、背景颜色，含预置 + 自定义）
   - 相框边距
   - 横竖图策略（优先读取素材默认方向）
   - 展示时长、过渡时长、是否淡入淡出
   - 单轨音频导入与预览（复杂音频编辑能力后置讨论）
5. 出错不崩溃，反馈友好：即使失败也应给出可理解原因与可执行下一步。

## 设计哲学（优先级参考）
- 80% 功能完备度
- 99% 易用度
- 90% 美观度与设计感
- 80% 成功率（阶段参考值）

> 注：以上比例用于优先级取舍，不作为严格数学指标。

## 中期目标 v2（执行顺序 + 验收标准）
对齐依据：`Docs/UI-Information-Architecture-v1.md`（流程与信息架构基线）。

### 1) 导出前风险甄别闭环（Preflight）
验收标准（可打勾）：
- [x] 导出前自动扫描所有素材（可读性、损坏、权限、尺寸/方向异常）。
- [x] 风险按级别展示：`可继续` / `建议处理` / `必须修复`。
- [x] 能定位到具体问题图片（至少文件名级别）。
- [x] 用户可一键选择“跳过问题素材并继续导出”。
- [x] Preflight 结果在导出界面可见，不依赖日志。

### 2) 预览即所得闭环（WYSIWYG）
验收标准（可打勾）：
- [x] 预览与导出使用同一套关键参数（时长、转场、Ken Burns、边距、风格）。
- [x] 时间轴拖动时有明确状态反馈（生成中/失败/成功）。
- [x] 关键时刻帧一致性测试稳定通过（默认风格 + 主要变体）。
- [x] 预览失败不影响后续继续操作（不崩溃、可恢复）。

### 3) 核心可定制性闭环
验收标准（可打勾）：
- [x] 相框与背景支持“预置风格 + 自定义颜色”。
- [x] 相框边距可视化可调。
- [x] 横竖图策略可配置（默认读取素材方向，并支持覆盖）。
- [x] 展示时长、过渡时长、淡入淡出开关在 UI 可直接调整。
- [x] 模板导入/导出可覆盖以上配置且向后兼容。

### 4) 音频 v1 闭环（单轨）
验收标准（可打勾）：
- [x] 支持拖拽或选择单条音频。
- [x] 可在预览中听到音频（基础预览即可）。
- [x] 导出视频含音频并与时间轴同步。
- [x] 音频异常（不可读/不支持）有友好提示且不崩溃。

### 5) 最小可用流程与 UI 完成度
验收标准（可打勾）：
- [x] 用户可在一个主界面完成“导入-预览-导出-恢复”。
- [x] 主操作/辅助操作分区清晰，按钮状态与状态机一致。
- [x] 失败卡片提供明确“下一步动作”，成功卡片提供“继续动作”。
- [x] 参数校验信息就地显示（inline），无需猜测错误原因。
- [x] 新用户在无文档条件下可完成首次导出。
  - 已调整：预览步骤标注为“可选”，引导文案明确“可直接导出 MP4”。

## 近期目标（vNext，1-2 周）
1. 完成“横竖图策略可配置”
- [x] 增加 `按素材方向 / 强制横图 / 强制竖图` 三档。
- [x] 预览与导出行为一致，并补对应测试。

2. 完成模板兼容性收口
- [x] 为新加入字段补模板兼容测试（老模板导入默认值）。
- [x] 为“风格/布局/铭牌/转场开关”补导出-导入回环验证。

3. 完成首用可达成度验证
- [x] 新用户脚本化走通“导入-预览-导出”并记录阻塞点。
- [x] 根据阻塞点微调文案与默认值（不做视觉重构）。
  - 已调整：默认导出路径自动落在“影片/PhotoTime-Output.mp4”，并补充首屏引导文案。

4. 音频 v1 设计与技术预研
- [x] 确认最小方案：单轨导入、预览可听、导出混流。
- [x] 形成实现草案与风险清单（暂不进入复杂编辑）。
  - 详见：`Docs/Audio-v1-Implementation-Plan.md`

## 当前迭代对齐记录（2026-02）
- [x] 导出状态文案统一构建，降低文案散落与后续修改成本。
- [x] 新增本地回归脚本：`./scripts/test-non-ui.sh`、`./scripts/test-audio-regression.sh`。
- [x] 修复音频时长读取过时 API（`AVURLAsset.duration`）并清理缩略图 actor 警告。
- [x] 补齐异步音频时长刷新回归测试（导入后可读、移除后清空）。

## 下一阶段目标 v3（待推进）
1. 导出失败诊断信息结构化
- [ ] 将失败信息组装升级为结构化模型（错误码/建议动作/建议文案/日志路径），减少字符串解析依赖。
- [ ] 为结构化失败信息增加单元测试，覆盖“有问题素材/无问题素材”两类场景。

2. 可观测性与排障效率
- [ ] 增加导出失败类型聚合统计（本地日志维度），便于快速判断高频失败原因。
- [ ] 增加一键采集最小排障包（配置快照 + 最近日志路径 + 失败摘要）的开发者入口（非 UI 测试覆盖）。

## 已确认产品取舍（当前版本）
- 兼容性：最低兼容版本统一为 `macOS 14.6`。
- 优先级：按中期目标 v2 顺序推进，音频相关能力放在最后实现。
- 暂不做：项目保存/复用（前提是稳定性已足够）。
- 暂不做：面向用户的稳定性指标看板与长期跟踪（前提是导出前风险甄别充分）。
- 错误处理：重点是“不崩溃 + 友好提示 + 尽可能定位到问题图片”。
- 日志定位：日志保留给开发排查使用，但不作为用户主路径能力。

## 本地测试（当前策略）
- 近期默认仅跑非 UI 测试（`PhotoTimeTests`），跳过 `PhotoTimeUITests`。
- 一键命令：
  - `./scripts/test-non-ui.sh`
- 音频导出关键回归（单轨附加 + 非循环 + 循环）：
  - `./scripts/test-audio-regression.sh`
- 等价 `xcodebuild` 命令（带 ad-hoc 签名，避免本机调试库签名导致的测试启动失败）：
  - `xcodebuild test -project PhotoTime.xcodeproj -scheme PhotoTime -destination 'platform=macOS' -derivedDataPath .derivedData CODE_SIGNING_ALLOWED=YES CODE_SIGNING_REQUIRED=NO CODE_SIGN_IDENTITY='-' -only-testing:PhotoTimeTests`
