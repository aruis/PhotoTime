# PhotoTime

PhotoTime 是一个面向摄影爱好者的 macOS 幻灯片导出工具。

## 远期目标（可迭代）
以下目标作为当前版本的长期方向，后续可根据实际进展持续微调。

1. 对标 Lightroom 的幻灯片导出能力（聚焦核心场景，不追求全产品覆盖）。
2. 极致易用、容易上手：支持拖拽导入，参数清晰，预览即所得（WYSIWYG）。
3. 导出体验稳定可预期：核心流程清晰，用户能在少步骤内完成导出。
4. 提供高价值可定制性：
   - 相框风格（相框颜色、背景颜色，含预置 + 自定义）
   - 相框边距
   - 横竖图策略（优先读取素材默认方向）
   - 展示时长、过渡时长、是否淡入淡出
   - 单轨音频导入与预览（复杂音频编辑能力后置讨论）
5. 出错不崩溃，反馈友好：即使失败也应给出可理解原因与可执行下一步。

## 设计哲学（优先级参考）
- 80% 功能完备度
- 99% 易用度
- 90% 美观度与设计感
- 80% 成功率（阶段参考值）

> 注：以上比例用于优先级取舍，不作为严格数学指标。

## 阶段基线（v2 已完成）
对齐依据：`Docs/UI-Information-Architecture-v1.md`（流程与信息架构基线）。

1. 导出前风险甄别闭环（Preflight）
- [x] 导出前自动扫描所有素材（可读性、损坏、权限、尺寸/方向异常）。
- [x] 风险按级别展示：`可继续` / `建议处理` / `必须修复`。
- [x] 能定位到具体问题图片（至少文件名级别）。
- [x] 用户可一键选择“跳过问题素材并继续导出”。
- [x] Preflight 结果在导出界面可见，不依赖日志。

2. 预览即所得闭环（WYSIWYG）
- [x] 预览与导出使用同一套关键参数（时长、转场、Ken Burns、边距、风格）。
- [x] 时间轴拖动时有明确状态反馈（生成中/失败/成功）。
- [x] 关键时刻帧一致性测试稳定通过（默认风格 + 主要变体）。
- [x] 预览失败不影响后续继续操作（不崩溃、可恢复）。

3. 核心可定制性闭环
- [x] 相框与背景支持“预置风格 + 自定义颜色”。
- [x] 相框边距可视化可调。
- [x] 横竖图策略可配置（默认读取素材方向，并支持覆盖）。
- [x] 展示时长、过渡时长、淡入淡出开关在 UI 可直接调整。
- [x] 模板导入/导出可覆盖以上配置且向后兼容。

4. 音频 v1 闭环（单轨）
- [x] 支持拖拽或选择单条音频。
- [x] 可在预览中听到音频（基础预览即可）。
- [x] 导出视频含音频并与时间轴同步。
- [x] 音频异常（不可读/不支持）有友好提示且不崩溃。

5. 最小可用流程与 UI 完成度
- [x] 用户可在一个主界面完成“导入-预览-导出-恢复”。
- [x] 主操作/辅助操作分区清晰，按钮状态与状态机一致。
- [x] 失败卡片提供明确“下一步动作”，成功卡片提供“继续动作”。
- [x] 参数校验信息就地显示（inline），无需猜测错误原因。
- [x] 新用户在无文档条件下可完成首次导出。

## 中期目标（v3，4-8 周）
1. 导出失败诊断信息结构化
- [x] 将失败信息组装升级为结构化模型（错误码/阶段/建议动作/建议文案/日志路径），减少字符串解析依赖。
- [x] 为结构化失败信息增加单元测试，覆盖“有问题素材/无问题素材”两类场景。

2. 可观测性与排障效率
- [x] 增加导出失败类型聚合统计（本地日志维度），便于快速判断高频失败原因。
- [ ] 增加一键采集最小排障包（配置快照 + 最近日志路径 + 失败摘要）的开发者入口（非 UI 测试覆盖）。

3. 发布工程化与交付质量门
- [x] 建立 CI 质量门（非 UI 测试 + 关键 UI smoke + 音频回归）。
- [ ] 收口发布前检查清单（权限、磁盘、兼容性、失败恢复链路）。

## 短期目标（当前两周执行计划）
### 第 1 周：稳定性封口（架构与错误模型）
1. 代码结构降耦
- [x] 将 `ContentView.swift` 中的业务层逻辑拆分到独立文件（至少：导出编排、音频编排、素材编排）。
- [x] 保持现有 UI 行为不变，避免重构引入体验回退。

2. 错误恢复从“文案匹配”升级到“结构化”
- [x] 为导出/预览失败定义统一错误上下文模型（错误码、阶段、建议动作、素材定位）。
- [x] `ExportRecoveryAdvisor` 优先基于错误码与上下文判定，降低 `localizedDescription` 关键词依赖。

3. 回归护栏补齐
- [x] 为上述重构点补测试（状态机、失败建议、素材定位、日志路径组装）。
- [x] 出口标准：`PhotoTimeTests` 全绿，且无现有行为回退。

### 第 2 周：质量门建设（可持续交付）
1. 自动化测试门禁
- [x] 增加关键 UI smoke 用例（首用导入-预览-导出、失败卡片恢复入口、音频导出主路径）。
- [ ] 增加异常场景回归（权限拒绝、缺失文件、无空间/不可写路径至少覆盖可稳定复现项）。

2. CI 集成
- [x] 在 CI 中串联 `./scripts/test-non-ui.sh` 与音频关键回归（`./scripts/test-audio-regression.sh`）。
- [x] 新增关键 UI smoke 作业，并定义失败阻断策略。

3. 质量门验收标准
- [ ] 任一 PR 合入前自动跑完上述门禁。
- [ ] 主流程回归失败可在 10 分钟内定位到具体阶段（导入/预检/预览/导出/混流）。

## 近期已完成（2026-02）
1. 完成“横竖图策略可配置”
- [x] 增加 `按素材方向 / 强制横图 / 强制竖图` 三档。
- [x] 预览与导出行为一致，并补对应测试。

2. 完成模板兼容性收口
- [x] 为新加入字段补模板兼容测试（老模板导入默认值）。
- [x] 为“风格/布局/铭牌/转场开关”补导出-导入回环验证。

3. 完成首用可达成度验证
- [x] 新用户脚本化走通“导入-预览-导出”并记录阻塞点。
- [x] 根据阻塞点微调文案与默认值（不做视觉重构）。
  - 已调整：默认导出路径自动落在“影片/PhotoTime-Output.mp4”，并补充首屏引导文案。

4. 音频 v1 设计与技术预研
- [x] 确认最小方案：单轨导入、预览可听、导出混流。
- [x] 形成实现草案与风险清单（暂不进入复杂编辑）。
  - 详见：`Docs/Audio-v1-Implementation-Plan.md`

5. 当前迭代对齐项
- [x] 导出状态文案统一构建，降低文案散落与后续修改成本。
- [x] 新增本地回归脚本：`./scripts/test-non-ui.sh`、`./scripts/test-audio-regression.sh`。
- [x] 新增关键 UI smoke 脚本：`./scripts/test-ui-smoke.sh`，并提供总门禁脚本 `./scripts/test-ci-gate.sh`。
- [x] 修复音频时长读取过时 API（`AVURLAsset.duration`）并清理缩略图 actor 警告。
- [x] 补齐异步音频时长刷新回归测试（导入后可读、移除后清空）。
- [x] 增加导出失败类型本地聚合统计（`~/Library/Application Support/PhotoTime/Diagnostics/export-failure-stats.json`）。

## 已确认产品取舍（当前版本）
- 兼容性：最低兼容版本统一为 `macOS 14.6`。
- 优先级：按“短期两周计划 -> 中期 v3 目标”顺序推进，优先保证稳定性与可交付性。
- 暂不做：项目保存/复用（前提是稳定性已足够）。
- 暂不做：面向用户的稳定性指标看板与长期跟踪（前提是导出前风险甄别充分）。
- 错误处理：重点是“不崩溃 + 友好提示 + 尽可能定位到问题图片”。
- 日志定位：日志保留给开发排查使用，但不作为用户主路径能力。

## 本地测试（当前策略）
- 默认先跑非 UI 测试，再按需补关键 UI smoke。
- 一键命令：
  - `./scripts/test-non-ui.sh`
- 音频导出关键回归（单轨附加 + 非循环 + 循环）：
  - `./scripts/test-audio-regression.sh`
- 关键 UI smoke（首用状态 + 成功/失败/校验场景）：
  - `./scripts/test-ui-smoke.sh`
- 本地 CI 门禁串联（non-ui + audio + ui smoke）：
  - `./scripts/test-ci-gate.sh`
- GitHub Actions CI：
  - `.github/workflows/ci.yml` 在 `push/pull_request` 上并行执行：
    - Non-UI Tests
    - Audio Regression
    - UI Smoke
  - 失败时自动上传 `xcresult` 产物，便于定位问题。
- 等价 `xcodebuild` 命令（带 ad-hoc 签名，避免本机调试库签名导致的测试启动失败）：
  - `xcodebuild test -project PhotoTime.xcodeproj -scheme PhotoTime -destination 'platform=macOS' -derivedDataPath .derivedData CODE_SIGNING_ALLOWED=YES CODE_SIGNING_REQUIRED=NO CODE_SIGN_IDENTITY='-' -only-testing:PhotoTimeTests`
